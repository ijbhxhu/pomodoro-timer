<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å°ˆæ³¨å°åŠ©æ‰‹ - éŸ³æ¨‚ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #e3f2fd;
            --main-color: #448aff;
            --button-hover: #2979ff;
        }

        .blue-theme {
            --bg-color: #e3f2fd;
            --main-color: #448aff;
            --button-hover: #2979ff;
        }

        .pink-theme {
            --bg-color: #fff1f2;
            --main-color: #f472b6;
            --button-hover: #db2777;
        }

        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            transition: 0.5s;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .card {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 30px;
            border-radius: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.05);
            text-align: center;
        }

        .theme-switch {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .mode-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            background: var(--bg-color);
            color: var(--main-color);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .timer {
            font-size: 80px;
            font-weight: 900;
            color: var(--main-color);
            margin: 10px 0;
            font-variant-numeric: tabular-nums;
        }

        /* éŸ³æ¨‚é¸æ“‡å™¨æ¨£å¼ */
        .music-selector {
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        select {
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 14px;
            outline: none;
            width: 80%;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-main { background: var(--main-color); color: white; flex-grow: 2; }
        .btn-reset { background: #eee; color: #777; flex-grow: 1; }

        .message { margin-top: 20px; color: #888; font-size: 14px; }

        .working { animation: pulse 2s infinite ease-in-out; }

        /* æ–°å¢æ¨£å¼ */
        .time-settings {
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .time-settings label {
            display: inline-block;
            margin: 0 10px;
            font-size: 14px;
        }

        .time-settings input {
            width: 50px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .volume-control {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats {
            margin-top: 15px;
            font-size: 16px;
            color: var(--main-color);
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .btn-group {
                flex-direction: column;
            }
            .btn-group button {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body class="blue-theme">

<div class="card">
    <div class="theme-switch">
        <div class="dot" style="background: #f472b6;" onclick="setTheme('pink')"></div>
        <div class="dot" style="background: #448aff;" onclick="setTheme('blue')"></div>
    </div>

    <div id="modeBadge" class="mode-badge">ğŸ“ è®€æ›¸æ™‚é–“</div>
    <div id="timerDisplay" class="timer">25:00</div>

    <div class="time-settings">
        <p style="font-size: 12px; margin: 0 0 5px 0; color: #666;">â° è‡ªè¨‚æ™‚é–“ (åˆ†é˜)</p>
        <label>å·¥ä½œ: <input type="number" id="workTime" value="25" min="1" max="60"></label>
        <label>ä¼‘æ¯: <input type="number" id="breakTime" value="5" min="1" max="30"></label>
    </div>

    <div class="music-selector">
        <p style="font-size: 12px; margin: 0 0 5px 0; color: #666;">ğŸµ å°ˆæ³¨èƒŒæ™¯éŸ³</p>
        <select id="bgmSelect" onchange="changeMusic()">
            <option value="">(ç„¡èƒŒæ™¯éŸ³)</option>
            <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">è¼•éŸ³æ¨‚ 1</option>
            <option value="https://actions.google.com/sounds/v1/water/rain_on_roof.ogg">èˆ’ç·©é›¨è²</option>
            <option value="https://actions.google.com/sounds/v1/ambiences/forest_morning_birds.ogg">æ£®æ—é³¥é³´</option>
        </select>
        <div class="volume-control">
            <span>ğŸ”Š</span>
            <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="0.5" onchange="setVolume()">
            <button onclick="toggleMute()">éœéŸ³</button>
        </div>
    </div>
    
    <div class="btn-group">
        <button id="startBtn" class="btn-main" onclick="toggleTimer()">é–‹å§‹å­¸ç¿’</button>
        <button class="btn-reset" onclick="reset()">é‡è¨­</button>
    </div>

    <div id="message" class="message">æº–å‚™å¥½è¿æ¥å……æ»¿æˆå°±æ„Ÿçš„ä¸€å¤©äº†å—ï¼Ÿ</div>
    <div id="stats" class="stats">ä»Šæ—¥è•ƒèŒ„: 0</div>
</div>

<audio id="bgmPlayer" loop></audio>

<script>
    let timeLeft = 25 * 60;
    let timerId = null;
    let isRunning = false;
    let currentMode = 'work';
    let pomodoroCount = 0;
    let isMuted = false;

    const display = document.getElementById('timerDisplay');
    const startBtn = document.getElementById('startBtn');
    const modeBadge = document.getElementById('modeBadge');
    const msg = document.getElementById('message');
    const bgmPlayer = document.getElementById('bgmPlayer');
    const bgmSelect = document.getElementById('bgmSelect');
    const workTimeInput = document.getElementById('workTime');
    const breakTimeInput = document.getElementById('breakTime');
    const volumeControl = document.getElementById('volumeControl');
    const stats = document.getElementById('stats');

    // è¼‰å…¥å„²å­˜ç‹€æ…‹
    function loadState() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) setTheme(savedTheme);

        const savedWorkTime = localStorage.getItem('workTime');
        if (savedWorkTime) workTimeInput.value = savedWorkTime;

        const savedBreakTime = localStorage.getItem('breakTime');
        if (savedBreakTime) breakTimeInput.value = savedBreakTime;

        const savedCount = localStorage.getItem('pomodoroCount');
        if (savedCount) {
            pomodoroCount = parseInt(savedCount);
            updateStats();
        }

        const savedVolume = localStorage.getItem('volume');
        if (savedVolume) {
            volumeControl.value = savedVolume;
            bgmPlayer.volume = savedVolume;
        }
    }

    // å„²å­˜ç‹€æ…‹
    function saveState() {
        localStorage.setItem('theme', document.body.className.replace('-theme', ''));
        localStorage.setItem('workTime', workTimeInput.value);
        localStorage.setItem('breakTime', breakTimeInput.value);
        localStorage.setItem('pomodoroCount', pomodoroCount);
        localStorage.setItem('volume', volumeControl.value);
    }

    // è«‹æ±‚é€šçŸ¥æ¬Šé™
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    loadState();

    // ç›£è½è¼¸å…¥è®ŠåŒ–
    workTimeInput.addEventListener('change', saveState);
    breakTimeInput.addEventListener('change', saveState);

    function setTheme(theme) {
        document.body.className = theme + '-theme';
        saveState();
    }

    function changeMusic() {
        const selectedSrc = bgmSelect.value;
        if (selectedSrc) {
            bgmPlayer.src = selectedSrc;
            if (isRunning && !isMuted) bgmPlayer.play();
        } else {
            bgmPlayer.pause();
            bgmPlayer.src = "";
        }
    }

    function setVolume() {
        bgmPlayer.volume = volumeControl.value;
        saveState();
    }

    function toggleMute() {
        isMuted = !isMuted;
        bgmPlayer.muted = isMuted;
        if (isRunning && !isMuted && bgmSelect.value) bgmPlayer.play();
    }

    function updateStats() {
        stats.textContent = `ä»Šæ—¥è•ƒèŒ„: ${pomodoroCount}`;
    }

    function toggleTimer() {
        if (isRunning) {
            clearInterval(timerId);
            startBtn.textContent = currentMode === 'work' ? 'ç¹¼çºŒå­¸ç¿’' : 'ç¹¼çºŒä¼‘æ¯';
            msg.textContent = 'æš«åœä¸­ï¼Œæ·±å‘¼å¸ä¸€ä¸‹ï¼';
            display.classList.remove('working');
            bgmPlayer.pause();
        } else {
            timerId = setInterval(() => {
                timeLeft--;
                updateDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    handleTimeUp();
                }
            }, 1000);
            startBtn.textContent = 'æš«åœ';
            msg.textContent = currentMode === 'work' ? 'åŠ æ²¹ï¼Œä½ æ˜¯æœ€æ£’çš„ï¼' : 'å¥½å¥½æ”¾é¬†çœ¼ç›å§ï½';
            display.classList.add('working');
            if (bgmSelect.value && !isMuted) bgmPlayer.play();
        }
        isRunning = !isRunning;
        saveState();
    }

    function handleTimeUp() {
        isRunning = false;
        bgmPlayer.pause();
        display.classList.remove('working');
        
        if (currentMode === 'work') {
            pomodoroCount++;
            updateStats();
            saveState();
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('ğŸ‰ å°ˆæ³¨å®Œæˆï¼', { body: 'ä½ å®Œæˆäº† 25 åˆ†é˜çš„å°ˆæ³¨ï¼' });
            } else {
                alert('ğŸ‰ å¤ªå²å®³äº†ï¼ä½ å®Œæˆäº† 25 åˆ†é˜çš„å°ˆæ³¨ï¼');
            }
            if (confirm('è¦é–‹å§‹ 5 åˆ†é˜çš„ä¼‘æ¯æ™‚é–“å—ï¼Ÿ')) {
                startBreak();
            } else {
                reset();
            }
        } else {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('â˜• ä¼‘æ¯çµæŸï¼', { body: 'æº–å‚™å¥½é–‹å§‹ä¸‹ä¸€æ®µå­¸ç¿’äº†å—ï¼Ÿ' });
            } else {
                alert('â˜• ä¼‘æ¯çµæŸï¼æº–å‚™å¥½é–‹å§‹ä¸‹ä¸€æ®µå­¸ç¿’äº†å—ï¼Ÿ');
            }
            reset();
        }
    }

    function startBreak() {
        currentMode = 'break';
        timeLeft = parseInt(breakTimeInput.value) * 60;
        modeBadge.textContent = 'â˜• ä¼‘æ¯æ™‚é–“';
        modeBadge.style.background = '#fff7ed';
        modeBadge.style.color = '#ffb74d';
        updateDisplay();
        toggleTimer();
    }

    function reset() {
        clearInterval(timerId);
        bgmPlayer.pause();
        isRunning = false;
        currentMode = 'work';
        timeLeft = parseInt(workTimeInput.value) * 60;
        modeBadge.textContent = 'ğŸ“ è®€æ›¸æ™‚é–“';
        modeBadge.style.background = '';
        modeBadge.style.color = '';
        startBtn.textContent = 'é–‹å§‹å­¸ç¿’';
        msg.textContent = 'æº–å‚™å¥½è¿æ¥å……æ»¿æˆå°±æ„Ÿçš„ä¸€å¤©äº†å—ï¼Ÿ';
        display.classList.remove('working');
        updateDisplay();
        saveState();
    }
</script>

</body>
</html>